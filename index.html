<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="ZXing for JS adapted by Buckland and Assis" />

    <title>ZXing TypeScript | Decoding from camera stream</title>

    <link
      rel="stylesheet"
      rel="preload"
      as="style"
      onload="this.rel='stylesheet';this.onload=null"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />
    <link
      rel="stylesheet"
      rel="preload"
      as="style"
      onload="this.rel='stylesheet';this.onload=null"
      href="https://unpkg.com/normalize.css@8.0.0/normalize.css"
    />
    <link
      rel="stylesheet"
      rel="preload"
      as="style"
      onload="this.rel='stylesheet';this.onload=null"
      href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css"
    />

  </head>

  <body>
    <main class="wrapper" style="padding-top: 2em">
      <section class="container" id="demo-content">
        <div>
          <a class="button" id="startButton">Start</a>
          <a class="button" id="resetButton">Reset</a>
        </div>

        <div>
          <video
            id="video"
            style="border: 1px solid gray; width: 100%; height: 100%"
          ></video>
        </div>

        <div id="sourceSelectPanel" style="display: none">
          <label for="sourceSelect">Change video source:</label>
          <select id="sourceSelect" style="max-width: 400px"></select>
        </div>

        <label>Result:</label>
        <pre><code id="result"></code></pre>
        <img src="foto.jpg" />
      </section>
    </main>

    <script
      type="text/javascript"
      src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"
    ></script>

    <script type="text/javascript">
      window.addEventListener("load", function () {
        let selectedDeviceId;
        const codeReader = new ZXing.BrowserMultiFormatReader();
        console.log("ZXing code reader initialized");

        codeReader
          .listVideoInputDevices()
          .then((videoInputDevices) => {
            const sourceSelect = document.getElementById("sourceSelect");
            if (videoInputDevices.length >= 1) {
              selectedDeviceId = videoInputDevices[0].deviceId;
              videoInputDevices.forEach((element) => {
                const sourceOption = document.createElement("option");
                sourceOption.text = element.label;
                sourceOption.value = element.deviceId;
                sourceSelect.appendChild(sourceOption);
              });

              sourceSelect.onchange = () => {
                selectedDeviceId = sourceSelect.value;
              };

              const sourceSelectPanel =
                document.getElementById("sourceSelectPanel");
              sourceSelectPanel.style.display = "block";
            } else {
              console.error("No se encontraron dispositivos de video.");
            }
          })
          .catch((error) =>
            console.error("Error al listar dispositivos de video:", error)
          );

        document.getElementById("startButton").addEventListener("click", () => {
          codeReader.decodeFromVideoDevice(
            selectedDeviceId,
            "video",
            (result, err) => {
              if (result) {
                console.log(result);

                // Verificar si es un código QR
                if (result.format === ZXing.BarcodeFormat.QR_CODE) {
                  alert(
                    "Código QR no aceptado, intenta con un código de barras válido"
                  );
                  window.location.reload();
                  return;
                }

                document.getElementById("result").textContent = result.text;

                fetch("https://localhost:3001/barcode", {
                  body: JSON.stringify({
                    barcode: result.text,
                  }),
                  mode: "cors",
                  method: "POST",
                  headers: new Headers({
                    "Content-Type": "application/json",
                  }),
                })
                  .then((response) => {
                    if (!response.ok) {
                      alert(
                        "Código de barras no aceptado, intenta con un código válido"
                      );
                      window.location.reload();
                    }
                    return response.json();
                  })
                  .then((serverResponse) => {
                    console.log("Respuesta del servidor => ", serverResponse);
                    // Continuar con el procesamiento según la respuesta del servidor
                  })
                  .catch((err) => {
                    console.log("Error en el fetch => ", err);
                    alert(
                      "Error al procesar el código de barras. Por favor, intenta nuevamente."
                    );
                  });
              }
              if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error(err);
                document.getElementById("result").textContent = err;
              }
            }
          );
          console.log(
            `Started continuous decode from camera with id ${selectedDeviceId}`
          );
        });

        document.getElementById("resetButton").addEventListener("click", () => {
          codeReader.reset();
          document.getElementById("result").textContent = "";
          console.log("Reset.");
        });
      });
    </script>
  </body>
</html>
