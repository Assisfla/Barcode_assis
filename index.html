<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="ZXing for JS adapted by Buckland&Assis" />

    <title>ZXing TypeScript | Decoding from camera stream</title>

    <link
      rel="stylesheet"
      rel="preload"
      as="style"
      onload="this.rel='stylesheet';this.onload=null"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />
    <link
      rel="stylesheet"
      rel="preload"
      as="style"
      onload="this.rel='stylesheet';this.onload=null"
      href="https://unpkg.com/normalize.css@8.0.0/normalize.css"
    />
    <link
      rel="stylesheet"
      rel="preload"
      as="style"
      onload="this.rel='stylesheet';this.onload=null"
      href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css"
    />
  </head>

  <body>
    <main class="wrapper" style="padding-top: 2em">
      <section class="container" id="demo-content">
        <div>
          <a class="button" id="startButton">Start</a>
          <a class="button" id="resetButton">Reset</a>
        </div>

        <div>
          <video
            id="video"
            style="border: 1px solid gray; width: 100%; height: 100%"
          ></video>
        </div>

        <div id="sourceSelectPanel" style="display: none">
          <label for="sourceSelect">Change video source:</label>
          <select id="sourceSelect" style="max-width: 400px"></select>
        </div>

        <label>Result:</label>
        <pre><code id="result"></code></pre>
      </section>
    </main>

    <script
      type="text/javascript"
      src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"
    ></script>

    <script type="text/javascript">
      window.addEventListener("load", function () {
        let selectedDeviceId;
        const codeReader = new ZXing.BrowserMultiFormatReader();
        console.log("ZXing code reader initialized");
        codeReader
          .listVideoInputDevices()
          .then((videoInputDevices) => {
            const sourceSelect = document.getElementById("sourceSelect");
            selectedDeviceId = videoInputDevices[0].deviceId;
            if (videoInputDevices.length >= 1) {
              videoInputDevices.forEach((element) => {
                const sourceOption = document.createElement("option");
                sourceOption.text = element.label;
                sourceOption.value = element.deviceId;
                sourceSelect.appendChild(sourceOption);
              });

              sourceSelect.onchange = () => {
                selectedDeviceId = sourceSelect.value;
              };

              const sourceSelectPanel =
                document.getElementById("sourceSelectPanel");
              sourceSelectPanel.style.display = "block";
            }

            document
  .getElementById("startButton")
  .addEventListener("click", () => {
    codeReader.decodeFromVideoDevice(
      selectedDeviceId,
      "video",
      (result, err) => {
        // El result es el número que vamos a enviar al servidor haciendo una request
        if (result) {
          console.log(result);
          document.getElementById("result").textContent = result.text;

          // Realizar la solicitud fetch al servidor
          fetch("https://localhost:3001/barcode", {
            body: JSON.stringify({
              barcode: result.text,
            }),
            mode: "cors",
            method: "POST",
            headers: new Headers({
              "Content-Type": "application/json",
            }),
          })
            .then((response) => {
              if (!response.ok) {
                // Verificar si la respuesta indica un error
                alert("Código de barras no aceptado, intenta con un código válido");
                window.location.reload();
              }
              return response.json();
            })
            .then((serverResponse) => {
              console.log("Respuesta del servidor => ", serverResponse);

              // Continuar con el procesamiento según la respuesta del servidor
              // ...
            })
            .catch((err) => {
              console.log("Error en el fetch => ", err);
              alert("Error al procesar el código de barras: Por favor, intenta nuevamente.")
            });

          // Ir a otra ventana del navegador
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
          document.getElementById("result").textContent = err;
        }
      }
    );
    console.log(
      `Started continuous decode from camera with id ${selectedDeviceId}`
    );
  });
         

        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
          document.getElementById("result").textContent = err;
        }
      }
    );
    console.log(
      `Started continuous decode from camera with id ${selectedDeviceId}`
    );
  });
            // document
            //   .getElementById("startButton")
            //   .addEventListener("click", () => {
            //     codeReader.decodeFromVideoDevice(
            //       selectedDeviceId,
            //       "video",
            //       (result, err) => {
            //         // el result es lo que numerito que vamos a mandar al servido haciendo una request
            //         if (result) {
            //           console.log(result);
            //           document.getElementById("result").textContent =
            //             result.text;

            //           fetch("https://localhost:3001/barcode", {
            //             body: JSON.stringify({
            //               barcode: result.text,
            //             }),
            //             mode: "cors",
            //             method: "POST",
            //             headers: new Headers({
            //               "Content-Type": "application/json",
            //             }),
            //           })
            //             .then((response) => response.json())
            //             .then((barcode) => {
            //               console.log(
            //                 "El lector ya tiene el barcode => ",
            //                 barcode
            //               );
            //               if (barcode.startsWith('https')) {
            //                 alert("Código de barras no aceptado, intenta con un código válido");
            //                 window.location.reload();
            //               }
            //               else {
            //                 return barcode;
            //               }
            //             })
            //             .catch((err) => {
            //               console.log("Error en el fetch => ", err);
            //               alert("Error al procesar el código de barras: Por favor, intenta nuevamente.")
            //             });

            //           // ir a otra ventana del navegador
            //         }
            //         if (err && !(err instanceof ZXing.NotFoundException)) {
            //           console.error(err);
            //           document.getElementById("result").textContent = err;
            //         }
            //       }
            //     );
            //     console.log(
            //       `Started continous decode from camera with id ${selectedDeviceId}`
            //     );
            //   });

            document
              .getElementById("resetButton")
              .addEventListener("click", () => {
                codeReader.reset();
                document.getElementById("result").textContent = "";
                console.log("Reset.");
              });
          })
          .catch((err) => {
            console.error(err);
          });
      });
    </script>
  </body>
</html>
